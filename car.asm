include HT66F70A.inc

ds	.section	'data'
STACK_ACC DB ?
STACK_PSW DB ?
STACK1_ACC DB ?
STACK1_PSW DB ?
STACK2_ACC DB ?
STACK2_PSW DB ?

CHECK DB ?


ROMBANK 0 cs
cs	.section	at  000h	'code'

	ORG 00H
	JMP INIT
	ORG 04H
	JMP EXT0_ISR;左轉
	ORG 08H
	JMP EXT1_ISR;右轉
	ORG 30H
	JMP EXT2_ISR;均速
INIT:
	CLR CHECK
	MOV A,10101000B
	MOV WDTC,A
	LCLR IFS0
	MOV A,00000010B ;PE0 PA4 ;PC4
	;當中斷輸出
	LMOV IFS0,A
	SET PEC0
	SET PAC4
	SET PCC4
	SET PEPU0
	SET PAPU4
	SET PCPU4
	MOV A,00101010B
	MOV INTEG,A
	SET INT0E
	SET INT1E
	SET INT2E
	SET	EMI
	
	
	CLR PCC5 ;馬達輸出
	CLR PDC3 ;馬達輸出
	
	
	;外不中斷 優先
	MOV A,00001111B
	LANDM A,PCS2
	MOV A,00100000B
	LORM A,PCS2
	
	MOV A,00001111B
	LANDM A,PDS1
	MOV A,00010000B
	LORM A,PDS1
	
	
	
	MOV A,00000000B
	MOV TM0C0,A
	MOV TM3C0,A
	
	MOV A,10101000B
	MOV TM0C1,A
	MOV TM3C1,A
	
	RESET:
	;CLR CHECK
	MOV A, LOW 500
	MOV TM0AL,A
	MOV A, LOW 500
	MOV TM3AL,A
	
	MOV A,HIGH 500
	MOV TM0AH , A
	MOV A,HIGH 500
	MOV TM3AH , A
	
	SET T0ON
	SET T3ON
	
	;--------------------------------------
	;POLLING INPUT
	
	
	SET PBC0
	SET PBPU0
	SET PBC1
	SET PBPU1
	
	
	
	LITTLE_CHANGE:
			MOV A, LOW 500
			MOV TM0AL,A
			MOV A, LOW 500
			MOV TM3AL,A
	
			MOV A,HIGH 500
			MOV TM0AH , A
			MOV A,HIGH 500
			MOV TM3AH , A
	
	
	SNZ PB1
	JMP LEFT_SIDE
	LEFT_BACK:
	SNZ PB0
	JMP RIGHT_SIDE
	RIGHT_BACK:
	JMP LITTLE_CHANGE
	
	
	;這邊是微調
	RIGHT_SIDE:
			MOV A, LOW 0
			MOV TM0AL,A
			MOV A, LOW 900
			MOV TM3AL,A
	
			MOV A,HIGH 0
			MOV TM0AH , A
			MOV A,HIGH 900
			MOV TM3AH , A
	JMP RIGHT_BACK
	
	LEFT_SIDE:
			MOV A, LOW 900
			MOV TM0AL,A
			MOV A, LOW 0
			MOV TM3AL,A
	
			MOV A,HIGH 900
			MOV TM0AH , A
			MOV A,HIGH 0
			MOV TM3AH , A
	JMP LEFT_BACK
	;--------------------------------------
	JMP $
	;SZ CHECK.0
	;JMP RESET
	
	
	
	EXT0_ISR:
		;右轉
		MOV STACK_ACC,A
		MOV A,STATUS
		MOV STACK_PSW,A
		;SET CHECK
		
			MOV A, LOW 0 ;225 350
			MOV TM0AL,A
			MOV A, LOW 1000
			MOV TM3AL,A
	
			MOV A,HIGH 0
			MOV TM0AH , A
			MOV A,HIGH 1000
			MOV TM3AH , A
		
		EXT0_RETURN:
			MOV A,STACK_PSW
			MOV STATUS,A
			MOV A,STACK_ACC
		RETI
		
	EXT1_ISR:
		;左轉--
		;SET CHECK
		MOV STACK1_ACC,A
		MOV A,STATUS
		MOV STACK1_PSW,A
		
			MOV A, LOW 1000
			MOV TM0AL,A
			MOV A, LOW 0
			MOV TM3AL,A
	
			MOV A,HIGH 1000
			MOV TM0AH , A
			MOV A,HIGH 0
			MOV TM3AH , A
		
		EXT1_RETURN:
			MOV A,STACK1_PSW
			MOV STATUS,A
			MOV A,STACK1_ACC
	
	
	RETI
	
	EXT2_ISR:
			;均速
		;SET CHECK
		MOV STACK2_ACC,A
		MOV A,STATUS
		MOV STACK2_PSW,A
		
			MOV A, LOW 500
			MOV TM0AL,A
			MOV A, LOW 500
			MOV TM3AL,A
	
			MOV A,HIGH 500
			MOV TM0AH , A
			MOV A,HIGH 500
			MOV TM3AH , A
		
		EXT2_RETURN:
			MOV A,STACK2_PSW
			MOV STATUS,A
			MOV A,STACK2_ACC
	
	
	RETI
		
		
	END